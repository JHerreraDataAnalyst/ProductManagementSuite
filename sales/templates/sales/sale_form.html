{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - Sistema de Inventario{% endblock %}

{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="post" id="sale-form">
                    {% csrf_token %}
                    
                    <!-- Información de la Venta -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.client.id_for_label }}" class="form-label">
                                    {{ form.client.label }} *
                                </label>
                                {{ form.client }}
                                {% if form.client.errors %}
                                <div class="text-danger small">
                                    {% for error in form.client.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="{{ form.payment_method.id_for_label }}" class="form-label">
                                    {{ form.payment_method.label }}
                                </label>
                                {{ form.payment_method }}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <div class="form-check form-switch mt-4">
                                    {{ form.is_paid }}
                                    <label class="form-check-label" for="{{ form.is_paid.id_for_label }}">
                                        {{ form.is_paid.label }}
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Items de la Venta -->
                    <h5 class="mb-3">
                        <i class="bi bi-cart-check"></i> Productos
                        <small class="text-muted">(Los precios se cargan automáticamente)</small>
                    </h5>
                    
                    {{ formset.management_form }}
                    <div id="formset-container">
                        {% for form in formset %}
                        <div class="row formset-row mb-3 border-bottom pb-3">
                            <div class="col-md-5">
                                <label class="form-label">Producto *</label>
                                {{ form.product }}
                                {{ form.id }}
                                {% if form.product.errors %}
                                <div class="text-danger small">
                                    {% for error in form.product.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Cantidad *</label>
                                {{ form.quantity }}
                                {% if form.quantity.errors %}
                                <div class="text-danger small">
                                    {% for error in form.quantity.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Precio Unit.</label>
                                <input type="text" class="form-control unit-price" readonly 
                                       placeholder="$0.00" data-product-id="">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Subtotal</label>
                                <input type="text" class="form-control item-total" readonly 
                                       placeholder="$0.00">
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">&nbsp;</label>
                                {% if formset.can_delete %}
                                <button type="button" class="btn btn-outline-danger btn-sm remove-form" 
                                        style="margin-top: 8px;">
                                    <i class="bi bi-trash"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <button type="button" id="add-form" class="btn btn-outline-primary mb-4">
                        <i class="bi bi-plus-circle"></i> Agregar Producto
                    </button>

                    <!-- Totales -->
                    <div class="row mb-4">
                        <div class="col-md-6 offset-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">Resumen de la Venta</h6>
                                    <table class="table table-borderless mb-0">
                                        <tr>
                                            <td><strong>Subtotal:</strong></td>
                                            <td id="subtotal" class="text-end">$0.00</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Impuesto (12%):</strong></td>
                                            <td id="tax" class="text-end">$0.00</td>
                                        </tr>
                                        <tr class="border-top">
                                            <td><strong>Total:</strong></td>
                                            <td id="total" class="text-end"><strong>$0.00</strong></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notas -->
                    <div class="mb-4">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">
                            {{ form.notes.label }}
                        </label>
                        {{ form.notes }}
                    </div>

                    <!-- Botones -->
                    <div class="d-flex justify-content-between">
                        <a href="{% if sale %}{% url 'sales:sale_detail' sale.pk %}{% else %}{% url 'sales:sale_list' %}{% endif %}" 
                           class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> 
                            {% if sale %}Actualizar{% else %}Registrar{% endif %} Venta
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Datos de productos (precios)
const productPrices = {
    {% for product in products %}
    "{{ product.id }}": {{ product.price }},
    {% endfor %}
};

// Datos de stock disponible
const productStock = {
    {% for product in products %}
    "{{ product.id }}": {{ product.stock_quantity }},
    {% endfor %}
};

document.addEventListener('DOMContentLoaded', function() {
    const formsetContainer = document.getElementById('formset-container');
    const addFormButton = document.getElementById('add-form');
    const totalForms = document.getElementById('id_form-TOTAL_FORMS');
    
    let formCount = parseInt(totalForms.value);

    // Función para agregar nuevo formulario
    addFormButton.addEventListener('click', function() {
        const newForm = document.querySelector('.formset-row').cloneNode(true);
        const formRegex = RegExp(`form-(\\d){1}-`, 'g');
        
        // Actualizar índices
        newForm.innerHTML = newForm.innerHTML.replace(formRegex, `form-${formCount}-`);
        
        // Limpiar valores
        newForm.querySelectorAll('input, select').forEach(input => {
            if (input.type !== 'hidden' && !input.classList.contains('unit-price') && !input.classList.contains('item-total')) {
                input.value = '';
            }
        });
        
        // Limpiar campos de precio y total
        newForm.querySelector('.unit-price').value = '';
        newForm.querySelector('.item-total').value = '';
        
        formsetContainer.appendChild(newForm);
        formCount++;
        totalForms.value = formCount;
        
        // Agregar event listeners al nuevo formulario
        addEventListenersToForm(newForm);
    });

    // Función para agregar event listeners a un formulario
    function addEventListenersToForm(form) {
        const productSelect = form.querySelector('select[name*="product"]');
        const quantityInput = form.querySelector('input[name*="quantity"]');
        const unitPriceField = form.querySelector('.unit-price');
        const itemTotalField = form.querySelector('.item-total');
        const removeButton = form.querySelector('.remove-form');

        // Event listener para cambio de producto
        productSelect.addEventListener('change', function() {
            const productId = this.value;
            if (productId && productPrices[productId]) {
                const price = productPrices[productId];
                unitPriceField.value = '$' + price.toFixed(2);
                unitPriceField.setAttribute('data-product-id', productId);
                
                // Actualizar stock disponible en el placeholder
                const stock = productStock[productId] || 0;
                quantityInput.setAttribute('max', stock);
                quantityInput.setAttribute('placeholder', `Stock: ${stock}`);
                
                calculateItemTotal(form);
                calculateTotals();
            } else {
                unitPriceField.value = '';
                unitPriceField.setAttribute('data-product-id', '');
                quantityInput.removeAttribute('max');
                quantityInput.setAttribute('placeholder', 'Cantidad');
                calculateItemTotal(form);
            }
        });

        // Event listener para cambio de cantidad
        quantityInput.addEventListener('input', function() {
            calculateItemTotal(form);
            calculateTotals();
            
            // Validar stock
            const productId = unitPriceField.getAttribute('data-product-id');
            const stock = productStock[productId] || 0;
            const quantity = parseInt(this.value) || 0;
            
            if (quantity > stock) {
                this.classList.add('is-invalid');
                this.nextElementSibling?.remove();
                const errorDiv = document.createElement('div');
                errorDiv.className = 'text-danger small';
                errorDiv.textContent = `Stock insuficiente. Disponible: ${stock}`;
                this.parentNode.appendChild(errorDiv);
            } else {
                this.classList.remove('is-invalid');
                this.nextElementSibling?.remove();
            }
        });

        // Event listener para botón eliminar
        if (removeButton) {
            removeButton.addEventListener('click', function() {
                form.remove();
                formCount--;
                totalForms.value = formCount;
                calculateTotals();
            });
        }
    }

    // Función para calcular total por item
    function calculateItemTotal(form) {
        const quantityInput = form.querySelector('input[name*="quantity"]');
        const unitPriceField = form.querySelector('.unit-price');
        const itemTotalField = form.querySelector('.item-total');
        
        const quantity = parseInt(quantityInput.value) || 0;
        const unitPriceText = unitPriceField.value.replace('$', '');
        const unitPrice = parseFloat(unitPriceText) || 0;
        
        const total = quantity * unitPrice;
        itemTotalField.value = total > 0 ? '$' + total.toFixed(2) : '';
    }

    // Función para calcular totales generales
    function calculateTotals() {
        let subtotal = 0;
        
        document.querySelectorAll('.formset-row').forEach(form => {
            const itemTotalField = form.querySelector('.item-total');
            const itemTotalText = itemTotalField.value.replace('$', '');
            const itemTotal = parseFloat(itemTotalText) || 0;
            subtotal += itemTotal;
        });
        
        const tax = subtotal * 0.12;
        const total = subtotal + tax;
        
        document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
        document.getElementById('tax').textContent = '$' + tax.toFixed(2);
        document.getElementById('total').textContent = '$' + total.toFixed(2);
    }

    // Agregar event listeners a los formularios existentes
    document.querySelectorAll('.formset-row').forEach(form => {
        addEventListenersToForm(form);
    });

    // Calcular totales iniciales
    calculateTotals();
});
</script>
{% endblock %}